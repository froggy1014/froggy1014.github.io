---
sidebar_position: 1
title: CLIë¥¼ í†µí•´ ì •ì  ë¹Œë“œ íŒŒì¼ CICDë¡œ ë°°í¬í•´ë³´ê¸°
last_update:
  date: 4/11/2024
tags: [ìŠ¤í„°ë””]
description: AWS CLI, Terraform, ê·¸ë¦¬ê³  GitHub Actionsë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì  ì›¹ì‚¬ì´íŠ¸ë¥¼ AWSì— ë°°í¬í•˜ê³ , ì´ ê³¼ì •ì„ ìë™í™”í•˜ëŠ” ì‹¤ìŠµì„ ë³µê¸°í•©ë‹ˆë‹¤.
---

### AWS, Terraform, GH CLI ì„¤ì¹˜

`AWS` ê°™ì€ ê²½ìš°ëŠ” êµ³ì´ `CLI`ë¡œ í•  í•„ìš”ê°€ ìˆë‚˜ ìƒê°ì´ ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. `CLI`ì—ì„œëŠ” ë˜ì§€ë§Œ `GUI`ì—ì„œëŠ” ì•ˆë˜ëŠ” ê¸°ëŠ¥ë“¤ì´ ìˆê³  ê·¸ëŸ¬í•œ ìë™í™”ë¥¼ í•˜ë ¤ë©´ `CLI`ê°€ í•„ìˆ˜ì´ê¸° ë•Œë¬¸ì— ì„¤ì¹˜ë¥¼ í•´ì¤˜ì•¼í•©ë‹ˆë‹¤.

- [AWS CLI Install](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
  ì €ëŠ” macOSë¥¼ ì‚¬ìš©ì¤‘ì´ê³ , `GUI Installer`ë¡œ ì„¤ì¹˜í•˜ì…”ë„ ë˜ì§€ë§Œ ì €ëŠ” `command line installer`ë¡œ ì§„í–‰ì„ í–ˆìŠµë‹ˆë‹¤. ë‘˜ì´ ì°¨ì´ëŠ” ì—†ì§€ë§Œ CLIê°€ í›¨ì”¬ ë¹ ë¥´ê³  í¸í•˜ê¸° ë•Œë¬¸ì— ì €ëŠ”... ê·¸ë¦¬ ì§„í–‰í•˜ì˜€ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì—¬ê¸°ì„œ `All users`ë‘ `Current user`ë¡œ ë‚˜ë‰˜ê²Œ ë˜ëŠ”ë° AWS CLIê°€ ì‹œìŠ¤í…œ ë‚´ì—ì„œ ì–´ë–»ê²Œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ì™€ ê´€ë ¨ëœ ë²”ìœ„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì‰½ê²Œ ë§í•˜ë©´ ë³¸ì¸ ê°œì¸ PCì—ì„œëŠ” `All users`ë¡œ ì„¤ì¹˜í•˜ì‹œë©´ ë˜ê³ , ë§Œì•½ íšŒì‚¬ ë…¸íŠ¸ë¶ì„ ì‚¬ìš©í•˜ëŠ”ë°, ê³µìœ í•˜ëŠ” ë…¸íŠ¸ë¶ì— ë©€í‹° í”„ë¡œí•„ì„ ì‚¬ìš©í•˜ê³  ê³„ì‹œë‹¤ë©´ current userë¡œ ì§„í–‰í•˜ì‹œë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

```bash
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /
aws --version
```

- [Terraform CLI Install](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)
  ì €ëŠ” `Homebrew`ë¥¼ í†µí•´ì„œ ë°”ë¡œ ì„¤ì¹˜ í•  ìˆ˜ ìˆì—ˆê³ , ì„¤ì¹˜ í›„ ë²„ì „ í™•ì¸ë§Œ í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

```bash
brew tap hashicorp/tap
brew install hashicorp/tap/terraform
terraform --version
```

- [GH CLI Install](https://github.com/cli/cli#installation)
  ì €í¬ê°€ ê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ `git commit` ì´ ì»¤ë§¨ë“œê°€ ì•„ë‹Œ Github `PR`, `issue`, `ë ˆí¬ì§€í† ë¦¬ ì‹œí¬ë¦¿ ì…‹ì—…` ê°™ì€ ì‘ì—…ì„ CLIë¥¼ í†µí•´ì„œ í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” CLI íˆ´ì…ë‹ˆë‹¤.

```bash
brew install gh
```

### Terraform ì´ë€ ?

ì˜¤í”ˆ ì†ŒìŠ¤ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ as Code(IaC) ì†Œí”„íŠ¸ì›¨ì–´ íˆ´ì…ë‹ˆë‹¤. êµ¬ì„± íŒŒì¼ë“¤ì€ `HCL(HashiCorp Configuration Language)`ë¡œ ì‘ì„±ë˜ë©° ì—¬ëŸ¬ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤(ì˜ˆ: Amazon Web Services, Microsoft Azure, Google Cloud Platform) ë° ì˜¨-í”„ë ˆë¯¸ìŠ¤ ìì›(ì˜ˆ: VMware vSphere)ì„ í¬í•¨í•œ `ë‹¤ì–‘í•œ ì„œë¹„ìŠ¤ì˜ ì¸í”„ë¼ë¥¼ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ìœ¼ë¡œ êµ¬ì¶•, ë³€ê²½ ë° ë²„ì „ ê´€ë¦¬`í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. **ìë™í™”ëœ ì¸í”„ë¼ ê´€ë¦¬**
2. **ë³µì¡í•œ ì¸í”„ë¼ì˜ ê°„ì†Œí™”**
3. **ë©€í‹° í´ë¼ìš°ë“œ ì§€ì›**
4. **ë²„ì „ ê´€ë¦¬ ë° í˜‘ì—…**
5. **ë³€ê²½ ê³„íš ë° ì¸ì‚¬ì´íŠ¸**

---

### AWS IAM ìƒì„±

ì•ì„œ ì„¤ì¹˜í•œ `AWS CLI`ë¥¼ í†µí•´ì„œ `AWS Resoure`ë¥¼ ê´€ë¦¬ ë° ì œì–´ë¥¼ í•˜ê¸° ìœ„í•´ì„œ `Identity and Access Management(IAM)`ë¥¼ ìƒì„±í•´ì„œ ì—‘ì„¸ìŠ¤ í‚¤ë¥¼ ë§Œë“¤ì–´ì„œ ë“±ë¡ì„ í•´ì¤˜ì•¼í•˜ëŠ” ê³¼ì •ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ìƒì„±ì„ í•´ì¤˜ì•¼í•©ë‹ˆë‹¤.

PATH : `AWS IAM` -> `ì•¡ì„¸ì„œ ê´€ë¦¬` -> `ì‚¬ìš©ì` -> `ì‚¬ìš©ì ìƒì„±`

1. ì‚¬ìš©ì ì´ë¦„ ì…ë ¥
2. ê¶Œí•œ ì„¤ì •

- ê·¸ë£¹ì— ì‚¬ìš©ì ì¶”ê°€
- ê¶Œí•œ ë³µì‚¬
- ì§ì ‘ ì •ì±… ì—°ê²°
  - ê¸°ì¡´ì— ì¡´ì¬í•˜ë˜ ê·¸ë£¹ê³¼ ë³µì‚¬í•  ê¶Œí•œì€ ë”°ë¡œ ì—†ìœ¼ë¯€ë¡œ ì´ ê¶Œí•œ ì˜µì…˜ì„ ì„ íƒ
  - `AdministratorAccess` ë§ ê·¸ëŒ€ë¡œ ëª¨ë“  ê¶Œí•œì„ ìœ„ì„í•˜ëŠ” ì •ì±… ( ìœ ì¶œë˜ë©´ êµ‰ì¥íˆ ìœ„í—˜í•  ê²ƒ )

3. ìœ ì € ìƒì„±

PATH : `AWS IAM` -> `ì•¡ì„¸ì„œ ê´€ë¦¬` -> `ì‚¬ìš©ì` -> `ìƒì„±ëœ ì‚¬ìš©ì` -> `ë³´ì•ˆ ìê²© ì¦ëª…` -> `ì•¡ì„¸ìŠ¤ í‚¤`

1. Command Line Interface ( CLI ) ì„ íƒ
2. ì„¤ëª… íƒœê·¸ ( optional ) ì‘ì„±
3. ì•¡ì„¸ìŠ¤ í‚¤ ìƒì„± ë° ë³µì‚¬

ê·¸ëŸ¬ë©´ ì•„ë˜ 3ê°œë¥¼ ì¸ì§€ í˜¹ì€ ê°€ì§€ê³  ê³„ì…”ì•¼í•©ë‹ˆë‹¤.

- `ì‚¬ìš©ì ì´ë¦„ ( User Name )`
- `ì•¡ì„¸ìŠ¤ í‚¤`
- `ì•¡ì„¸ìŠ¤ í‚¤ ì‹œí¬ë¦¿`

---

### AWS CLI Profile ì„¤ì •

- `ap-northeast-2`ê°€ ì„œìš¸ì´ë‹¤.

```bash
aws configure --profile USER_NAME
AWS Access Key ID [None]: YOUR_ACCESS_KEY
AWS Secret Access Key [None]: YOUR_ACCESS_KEY_SECRET
Default region name [None]: ap-northeast-2
Default output format [None]: json
```

### ì¸í”„ë¼ ì„¤ëª… - [ì‹¤ìŠµ ì§„í–‰í•œ ë ˆí¬](https://github.com/monthly-cs/2024-04-cicd-week-1-template)

![Infra](/img/study/Infra.png)

#### DNS ë¦¬ì†ŒìŠ¤ ë°°í¬

`terraform init` : Terraform ì´ˆê¸°í™” ëª…ë ¹ì…ë‹ˆë‹¤. Terraformì´ ì‘ì—…ì„ ì‹œì‘í•˜ê¸° ì „ì— í•„ìš”í•œ ì—¬ëŸ¬ ì„¤ì •ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´ëŠ” Terraformì´ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í”ŒëŸ¬ê·¸ì¸ ë° ëª¨ë“ˆì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ë“±ì˜ ì¤€ë¹„ ì‘ì—…ì„ í¬í•¨í•©ë‹ˆë‹¤.

`terraform apply` : Terraformì„ ì‚¬ìš©í•˜ì—¬ ì¸í”„ë¼ë¥¼ ìƒì„±, ì—…ë°ì´íŠ¸ ë˜ëŠ” ì‚­ì œí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. Terraform êµ¬ì„± íŒŒì¼ë“¤ì˜ ì •ì˜ì— ë”°ë¼ í´ë¼ìš°ë“œ ë¦¬ì†ŒìŠ¤ë¥¼ ì‹¤ì œë¡œ ìƒì„±, ë³€ê²½ ë˜ëŠ” ì œê±°í•©ë‹ˆë‹¤.

| íŒŒì¼ëª…           | ì„¤ëª…                                        | ì£¼ìš” êµ¬ì„± ìš”ì†Œ                                                                                                                                                                        |
| ---------------- | ------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `_.output.tf`    | AWS Route 53ì˜ DNS ë„¤ì„ì„œë²„(NS) ë ˆì½”ë“œ ì¶œë ¥ | - `aws_route53_zone.zone.name_servers`: Route 53ì—ì„œ ìƒì„±ëœ í˜¸ìŠ¤íŒ… ì˜ì—­ì˜ DNS ë„¤ì„ì„œë²„ ì°¸ì¡°                                                                                           |
| `_.provider.tf`  | AWS í”„ë¡œë°”ì´ë” ì„¤ì •                         | - `provider "aws"`: AWS í”„ë¡œë°”ì´ë” ì„ ì–¸ `profile = var.profile`: ì‚¬ìš©í•  AWS CLI í”„ë¡œí•„ ì§€ì • - `region = var.region`: ì‚¬ìš©í•  AWS ë¦¬ì „ ì§€ì •                                             |
| `_.variables.tf` | ë³€ìˆ˜ ì •ì˜                                   | - `profile`: AWS CLI í”„ë¡œí•„ ì´ë¦„ - `region`: AWS ë¦¬ì „, ê¸°ë³¸ê°’ "us-east-1" - `domain_name`: ë„ë©”ì¸ ì´ë¦„, Route 53 í˜¸ìŠ¤íŒ… ì˜ì—­ ë° S3 ë²„í‚· ì„¤ì •ì— ì‚¬ìš©                                   |
| `acm_record`     | Route 53 ë ˆì½”ë“œ ìƒì„±                        | - `resource "aws_route53_record" "acm_record"`: Route 53 ë ˆì½”ë“œ ìƒì„± ì„ ì–¸ - `zone_id`, `name`, `type`, `records`, `ttl`: ë ˆì½”ë“œ ì†ì„± ì„¤ì • - `depends_on`: ì˜ì¡´ì„± ì„¤ì •                 |
| `acm.tf`         | AWS ACM ì¸ì¦ì„œ ìƒì„±                         | - `resource "aws_acm_certificate" "acm"`: ACM ì¸ì¦ì„œ ìƒì„± ì„ ì–¸ - `domain_name = var.domain_name`, `validation_method = "DNS"`, `lifecycle`, `depends_on`, `tags`: ì¸ì¦ì„œ ì†ì„± ë° ì„¤ì • |
| `sample.tfvars`  | Terraform ë³€ìˆ˜ ê°’ ì„¤ì •                      | - `profile = "edint_official"`, `region = "us-east-1"`, `domain_name = "unchaptered.shop"`: í”„ë¡œë°”ì´ë” ì„¤ì • ë° ë„ë©”ì¸ ì´ë¦„ ì„¤ì •ì— í•„ìš”í•œ ë³€ìˆ˜ ê°’ ì§€ì •                                 |
| `zone.tf`        | Route 53 í˜¸ìŠ¤íŒ… ì˜ì—­ ìƒì„±                   | - `resource "aws_route53_zone" "zone"`: í˜¸ìŠ¤íŒ… ì˜ì—­ ìƒì„± ì„ ì–¸ - `name = var.domain_name`, `comment = "Created by monthly-cs"`, `tags`: í˜¸ìŠ¤íŒ… ì˜ì—­ ì´ë¦„, ì„¤ëª…, íƒœê·¸ ì„¤ì •              |

```bash
cd ./infra/dns
terraform init
terraform apply -var="profile=YOUR_USER_NAME" -var="domain_name=YOUR_DOMAIN"
```

- terraform applyë¥¼ ì…ë ¥í•˜ê³  `Do you want to perform these actions?` ì´ë¼ëŠ” ì§ˆë¬¸ì— `yes`ë¥¼ ì…ë ¥í•´ì•¼ ë¹„ë¡œì†Œ ë¦¬ì†ŒìŠ¤ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤.

![terraform](/img/study/terraform apply.png)

`AWS Route 53 í˜¸ìŠ¤íŒ… ì˜ì—­ì´ ìƒì„±`ë˜ê³ , ê·¸ ê²°ê³¼ë¡œ `ë„¤ì„ì„œë²„(NS) ì£¼ì†Œ` 4ê°œê°€ ë°˜í™˜ë˜ëŠ” ê²ƒì„ í™•ì¸í•˜ê³ , í•´ë‹¹ ë„¤ì„ ì„œë²„ë¥¼ ë„ë©”ì¸ êµ¬ë§¤í•œ ê¸°ê´€ì— ë“±ë¡í•´ì¤ë‹ˆë‹¤.

![ë„¤ì„ì„œë²„](/img/study/ë„¤ì„ì„œë²„.png)
![gabia](/img/study/gabia.png)

#### **CloudFront, S3 ë°°í¬í•˜ê¸°**

```bash
cd ./infra/website
terraform init
terraform apply -var="profile=YOUR_USER_NAME" -var="domain_name=YOUR_DOMAIN"
```

| íŒŒì¼ëª…                 | ì„¤ëª…                                      | ì£¼ìš” êµ¬ì„± ìš”ì†Œ                                                                                                                                                                                                                                                                                   |
| ---------------------- | ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `_.datasource.acm.tf`  | AWS ACM ì¸ì¦ì„œ ë°ì´í„° ì¡°íšŒ                | - `data "aws_acm_certificate" "acm"`: ì¸ì¦ì„œ ë°ì´í„° ì¡°íšŒ ì„ ì–¸ - `domain = var.domain_name`: ì¡°íšŒí•  ë„ë©”ì¸ ì´ë¦„ ì§€ì • - `statuses = ["PENDING_VALIDATION", "ISSUED"]`: ì¡°íšŒí•  ì¸ì¦ì„œ ìƒíƒœ ì§€ì •                                                                                                     |
| `_.datasource.zone.tf` | AWS Route 53 í˜¸ìŠ¤íŒ… ì˜ì—­ ë°ì´í„° ì¡°íšŒ      | - `data "aws_route53_zone" "zone"`: í˜¸ìŠ¤íŒ… ì˜ì—­ ë°ì´í„° ì¡°íšŒ ì„ ì–¸ - `name = "${var.domain_name}."`: ì¡°íšŒí•  í˜¸ìŠ¤íŒ… ì˜ì—­ ì´ë¦„ ì§€ì •                                                                                                                                                                  |
| `_.providier.tf`       | AWS í”„ë¡œë°”ì´ë” ì„¤ì •                       | - `provider "aws"`: AWS í”„ë¡œë°”ì´ë” ì„ ì–¸ - `profile = var.profile`: ì‚¬ìš©í•  AWS CLI í”„ë¡œí•„ ì§€ì • - `region = var.region`: ì‚¬ìš©í•  AWS ë¦¬ì „ ì§€ì •                                                                                                                                                      |
| `_.variables.tf`       | Terraform ë³€ìˆ˜ ì •ì˜                       | - `variable "profile"`, `variable "region"`, `variable "domain_name"`: AWS CLI í”„ë¡œí•„ ì´ë¦„, AWS ë¦¬ì „, ë„ë©”ì¸ ì´ë¦„ ë³€ìˆ˜ ì •ì˜                                                                                                                                                                      |
| `cloudfront_acm.tf`    | AWS Route 53 A ë ˆì½”ë“œ ìƒì„±                | - `resource "aws_route53_record" "acm"`: A ë ˆì½”ë“œ ìƒì„± ì„ ì–¸ - `zone_id = data.aws_route53_zone.zone.id`: í˜¸ìŠ¤íŒ… ì˜ì—­ ID ì§€ì • - `name = var.domain_name`: ë ˆì½”ë“œ ì´ë¦„ ì§€ì • - `type = "A"`: ë ˆì½”ë“œ íƒ€ì… ì§€ì •                                                                                       |
| `cloudfront_oac.tf`    | AWS CloudFront Origin Access Control ìƒì„± | - `resource "aws_cloudfront_origin_access_control" "cf_dist_oac"`: OAC ìƒì„± ì„ ì–¸ - `name`, `description`, `origin_access_control_origin_type`, `signing_behavior`, `signing_protocol`: OAC ì†ì„± ì„¤ì •                                                                                             |
| `cloudfront.tf`        | AWS CloudFront ë°°í¬ ìƒì„±                  | - `resource "aws_cloudfront_distribution" "cf_dist"`: CloudFront ë°°í¬ ìƒì„± ì„ ì–¸ - `enabled`, `price_class`, `aliases`, `is_ipv6_enabled`, `default_root_object`, `origin`, `default_cache_behavior`, `restrictions`, `viewer_certificate`, `custom_error_response`, `depends_on`: ë°°í¬ ì†ì„± ì„¤ì • |
| `s3_bucket_policy.tf`  | AWS S3 ë²„í‚· ì •ì±… ìƒì„±                     | - `resource "aws_s3_bucket_policy" "bucket_policy"`: S3 ë²„í‚· ì •ì±… ìƒì„± ì„ ì–¸ - `bucket`, `policy`, `depends_on`: ë²„í‚· ì •ì±… ì†ì„± ë° ì˜ì¡´ì„± ì„¤ì •                                                                                                                                                    |
| `s3.tf`                | AWS S3 ë²„í‚· ìƒì„±                          | - `resource "aws_s3_bucket" "bucket"`: S3 ë²„í‚· ìƒì„± ì„ ì–¸ - `bucket = var.domain_name`: ë²„í‚· ì´ë¦„ ì§€ì • - `tags`: ë²„í‚· íƒœê·¸ ì„¤ì •                                                                                                                                                                   |

ë„ë©”ì¸ ì´ë¦„ì„ ê°€ì§„ ì›¹ ì‚¬ì´íŠ¸ë¥¼ ìœ„í•œ ì¸í”„ë¼ë¥¼ AWS ìƒì— êµ¬ì¶•í•©ë‹ˆë‹¤. ì´ ê³¼ì •ì—ëŠ” SSL/TLS ì¸ì¦ì„œì˜ ê´€ë¦¬, ë„ë©”ì¸ì˜ DNS ì„¤ì •, ì›¹ ì½˜í…ì¸ ì˜ ì €ì¥ ë° ì „ì„¸ê³„ ë°°í¬ê°€ í¬í•¨ë©ë‹ˆë‹¤. Terraformì„ í†µí•´ ì´ ëª¨ë“  ì‘ì—…ì„ ì½”ë“œí™”í•¨ìœ¼ë¡œì¨ ì¸í”„ë¼ì˜ ë²„ì „ ê´€ë¦¬, ì¬ì‚¬ìš©, ìë™í™”ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

### ë¡œì»¬ì—ì„œ ì •ì  ë¹Œë“œíŒŒì¼ ì—…ë¡œë“œ

í˜„ì¬ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  ì •ì  íŒŒì¼ ì €ì¥ë˜ëŠ” í´ë”ê°€ `./build` ë¼ëŠ” ê²½ë¡œë¼ëŠ” ê°€ì •í•˜ì— ëª…ë ¹ì–´ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```bash
aws s3 cp --recursive ./build s3://YOUR_DOMAIN --profile YOUR_PROFILE
```

### Github Actionì„ í†µí•œ CD êµ¬í˜„

```bash
î‚° gh auth login
? What account do you want to log into? GitHub.com
? What is your preferred protocol for Git operations on this host? HTTPS
? Authenticate Git with your GitHub credentials? Yes
? How would you like to authenticate GitHub CLI? Login with a web browser

! First copy your one-time code: C157-6EA4
Press Enter to open github.com in your browser...
```

ìœ„ì™€ ê°™ì´ ì§„í–‰ì„ í•´ì„œ ë¡œê·¸ì¸ì„ ì§„í–‰í•©ë‹ˆë‹¤.
ë‚´ Repositoryì— ì•„ë˜ì™€ ê°™ì´ í•„ìš”í•œ `Github secret`ì„ CLIë¡œ ë“±ë¡ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
gh secret set AWS_ACCESS_KEY -R <ìœ ì €ë„¤ì„>/<ì €ì¥ì†Œëª…> -b <AWS ACCESS KEY>
gh secret set AWS_SECRET_ACCESS_KEY -R <ìœ ì €ë„¤ì„>/<ì €ì¥ì†Œëª…> -b <AWS SECRET ACCESS KEY>
gh secret set AWS_S3_BUCKET -R <ìœ ì €ë„¤ì„>/<ì €ì¥ì†Œëª…> -b <ê°€ë¹„ì•„ì—ì„œ êµ¬ë§¤í•œ ë„ë©”ì¸ ì´ë¦„>
gh secret set AWS_CF_DIST_ID -R <ìœ ì €ë„¤ì„>/<ì €ì¥ì†Œëª…> -b <CloudFront ë°°í¬ ID>
```

ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆëŠ”ë°

PATH: `Repository` -> `Settings` -> `Security` -> `Secrets and variables` -> `Actions`

![github_secret](/img/study/github_secret.png)

#### Github Secretì´ë€ ?

ê¹ƒí—™(GitHub) ì‹œí¬ë¦¿(GitHub Secrets)ì€ ê¹ƒí—™ ë¦¬í¬ì§€í† ë¦¬(repository)ì—ì„œ ì‚¬ìš©ë˜ëŠ” ë¹„ê³µê°œ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ê¸° ìœ„í•œ ë°©ë²•ì¸ë°, ì£¼ë¡œ `ê¹ƒí—™ ì•¡ì…˜(GitHub Actions)ì´ë‚˜ ë‹¤ë¥¸ ìë™í™”ëœ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì¤‘ìš”í•œ ì •ë³´ë‚˜ êµ¬ì„± ë°ì´í„°ë¥¼ í¬í•¨`í•©ë‹ˆë‹¤.

```bash
.github
â”” workflows
  â”” deploy.yml
```

ë£¨íŠ¸ì—ì„œ ìœ„ì™€ ê°™ì´ deploy.yml íŒŒì¼ì„ ìƒì„±í•´ì¤ë‹ˆë‹¤.

```yaml
name: ë°°í¬ ìë™í™”

on:
  push:
    branches: ["*"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Node v
        run: node -v

      - name: setup-node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: yarn install

      - name: Build
        run: yarn build

      - name: Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY  }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY  }}
        run: aws s3 cp --recursive --region us-east-1 ./build s3://${{ secrets.AWS_S3_BUCKET  }}

      - name: Invalidate CloudFront Cache
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_EC2_METADATA_DISABLED: true
        run: aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_CF_DIST_ID  }} --paths "/*"
```

`deploy.yml`ì— ìœ„ ì½”ë“œë¥¼ ì‘ì„±í•´ì¤ë‹ˆë‹¤. ê° ì—­í• ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

`on`: ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `push` ì´ë²¤íŠ¸ì— ëŒ€í•´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©°, ëª¨ë“  ë¸Œëœì¹˜(`["*"]`)ë¡œë¶€í„°ì˜ í‘¸ì‹œ ì´ë²¤íŠ¸ì— ë°˜ì‘í•˜ì—¬ ì‹¤í–‰ë©ë‹ˆë‹¤.

`jobs`: ì›Œí¬í”Œë¡œìš° ë‚´ì—ì„œ ì‹¤í–‰ë  ì‘ì—…ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `build`ë¼ëŠ” í•˜ë‚˜ì˜ ì‘ì—…ì„ ì •ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.

- `runs-on`: ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½ì„ `ubuntu-latest`ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ì¦‰, ìµœì‹  ë²„ì „ì˜ ìš°ë¶„íˆ¬ ê°€ìƒ í™˜ê²½ì—ì„œ ì‘ì—…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.

- `steps`: ì‘ì—…ì„ êµ¬ì„±í•˜ëŠ” ë‹¨ê³„ë“¤ì„ ë‚˜ì—´í•©ë‹ˆë‹¤.

  - **Checkout**: `actions/checkout@v4`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤. ì´ëŠ” ì‘ì—…ì´ ì‹¤í–‰ë˜ëŠ” ê°€ìƒ í™˜ê²½ì— ì†ŒìŠ¤ ì½”ë“œë¥¼ ë³µì‚¬í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.
  - **Check Node v**: `node -v` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ í˜„ì¬ ë…¸ë“œ ë²„ì „ì„ í™•ì¸í•©ë‹ˆë‹¤.
  - **setup-node**: `actions/setup-node@v3`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `node-version`ì„ `20`ìœ¼ë¡œ ì„¤ì •í•˜ì—¬, í•´ë‹¹ ë²„ì „ì˜ Node.jsë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
  - **Install Dependencies**: `yarn install` ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ í•„ìš”í•œ ì˜ì¡´ì„±ë“¤ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
  - **Build**: `yarn build` ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•©ë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ìƒì„±ëœ ë¹Œë“œ íŒŒì¼ë“¤ì€ ë°°í¬ë¥¼ ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
  - **Upload to S3**: `aws s3 cp` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œëœ íŒŒì¼ë“¤ì„ AWS S3 ë²„í‚·ìœ¼ë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
  - **Invalidate CloudFront Cache**: `aws cloudfront create-invalidation` ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ CloudFront ìºì‹œë¥¼ ë¬´íš¨í™”í•©ë‹ˆë‹¤. ì´ëŠ” ìƒˆë¡œ ë°°í¬ëœ ì»¨í…ì¸ ê°€ CloudFrontë¥¼ í†µí•´ ì œê³µë  ë•Œ ì´ì „ ë²„ì „ì˜ ìºì‹œëœ ì»¨í…ì¸ ê°€ ì•„ë‹Œ ìµœì‹  ì»¨í…ì¸ ê°€ ì œê³µë˜ë„ë¡ í•©ë‹ˆë‹¤.

### S3, cloudfront, dns ì •ë¦¬ command ğŸ—‘ï¸

```bash
aws s3 rm s3://YOUR_DOMAIN --recursive --profile YOUR_PROFILE
```

> s3 bucketì— ë“¤ì–´ìˆëŠ” ì •ì  íŒŒì¼ ì „ë¶€ ì‚­ì œ

```bash
cd ./infra/website
terraform destroy -var="profile=YOUR_PROFILE" -var="domain_name=YOUR_DOMAIN"
```

> ìƒì„±ëœ AWS ë¦¬ì†ŒìŠ¤ (ì˜ˆ: EC2 ì¸ìŠ¤í„´ìŠ¤, S3 ë²„í‚·, Route53 DNS ë ˆì½”ë“œ ë“±) ì‚­ì œ

```bash
cd ../dns
terraform destroy -var="profile=YOUR_PROFILE" -var="domain_name=YOUR_DOMAIN"
```

> DNS ë ˆì½”ë“œ, ë„ë©”ì¸ ë“±ë¡, SSL/TLS ì¸ì¦ì„œ ë“±ì˜ ë„ë©”ì¸ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ ì‚­ì œ

### ì°¸ê³ 

- [1](https://novemberde.github.io/post/2018/06/20/AWS-config-switching/)
- [2](https://inblog.ai/unchaptered/cloudfront-s3-oneclick-deploy-18023)
- [3](https://inblog.ai/unchaptered/github-action-react-continuous-delivery-cf-s3-17985)
- [4](https://dev.to/1zyik/host-a-static-website-on-aws-using-s3-route-53-aws-certificate-manager-and-cloudfront-3mi6)
